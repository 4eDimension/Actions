name: Set Package Version
description: Safely bump version in package.json and create non-prefixed git tag

inputs:
  mode:
    required: true
    type: string

outputs:
  version:
    value: ${{ steps.bump.outputs.version }}
  tag:
    value: ${{ steps.bump.outputs.tag }}
  mode:
    value: ${{ inputs.mode }}

runs:
  using: "composite"
  steps:

    - name: Configure Git
      run: |
        git config --local user.name "GitHub Action"
        git config --local user.email "action@github.com"
      shell: bash

    - name: Pull latest changes
      run: git pull origin main
      shell: bash

    - name: Fetch remote tags
      run: git fetch --tags --force
      shell: bash

    - name: Handle version bump (safe, without v-prefix)
      id: bump
      run: |
        MODE="${{ inputs.mode }}"
        CURRENT_VERSION=$(jq -r .version package.json)

        echo "ðŸ“¦ Version actuelle : $CURRENT_VERSION"

        # DÃ©couper MAJOR.MINOR.PATCH
        IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

        # IncrÃ©ment selon le mode
        if [ "$MODE" == "major" ]; then
          MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0
        elif [ "$MODE" == "minor" ]; then
          MINOR=$((MINOR + 1)); PATCH=0
        elif [ "$MODE" == "patch" ]; then
          PATCH=$((PATCH + 1))
        else
          echo "âŒ Mode inconnu: $MODE"
          exit 1
        fi

        NEXT_VERSION="$MAJOR.$MINOR.$PATCH"
        echo "ðŸŽ¯ Nouvelle version : $NEXT_VERSION"

        # VÃ©rifier si le tag existe localement
        if git rev-parse "$NEXT_VERSION" >/dev/null 2>&1; then
          echo "âš ï¸ Tag local $NEXT_VERSION existe dÃ©jÃ , suppression"
          git tag -d "$NEXT_VERSION"
        fi

        # VÃ©rifier si le tag existe Ã  distance
        if git ls-remote --tags origin | grep -q "refs/tags/$NEXT_VERSION"; then
          echo "âŒ Le tag $NEXT_VERSION existe dÃ©jÃ  Ã  distance. Annulation."
          exit 1
        fi

        # Mettre Ã  jour package.json
        jq --arg v "$NEXT_VERSION" '.version=$v' package.json > tmp && mv tmp package.json
        git add package.json
        git commit -m "chore: bump version to $NEXT_VERSION"

        # CrÃ©er le tag non prÃ©fixÃ©
        git tag "$NEXT_VERSION"
        echo "ðŸ·ï¸ Tag crÃ©Ã© : $NEXT_VERSION"

        # Exposer version et tag comme outputs
        echo "version=${NEXT_VERSION}" >> "$GITHUB_OUTPUT"
        echo "tag=${NEXT_VERSION}" >> "$GITHUB_OUTPUT"
      shell: bash

    - name: Push commit + tag courant
      run: |
        git push origin main
        git push origin ${{ steps.bump.outputs.tag }}
      shell: bash